#!/bin/bash
# ูุฑูู ุงููุดุฑ - ุณูุฑูุจุช ุงููุดุฑ ุงูุขูู
# ุงูุฅุตุฏุงุฑ: 1.0.0
# ุงูุชุงุฑูุฎ: 2024
# ุงููุฑูู: ุงููููุฏุณ ุฑุงููุ ุงูุฏูุชูุฑ ูุงุฒู

echo "========================================="
echo "๐ ูุฑูู ุงููุดุฑ ูุงูุชุดุบูู ูุจุฏุฃ ุงูุนูู"
echo "========================================="
echo "ุงูุฃุนุถุงุก: ุงููููุฏุณ ุฑุงูู | ุงูุฏูุชูุฑ ูุงุฒู"
echo "========================================="

# ุงูุฃููุงู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}โถ $1${NC}"
}

print_success() {
    echo -e "${GREEN}โ $1${NC}"
}

print_error() {
    echo -e "${RED}โ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}โ๏ธ $1${NC}"
}

# =========================================
# ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ุงููููุงุช
# =========================================
print_step "1. ุงููููุฏุณ ุฑุงูู: ุงูุชุญูู ูู ุงููููุงุช..."

if [ ! -f "bot_arabic.py" ]; then
    print_error "ููู bot_arabic.py ุบูุฑ ููุฌูุฏ"
    exit 1
fi

print_success "ุงูููู ุงูุฑุฆูุณู ููุฌูุฏ"

# =========================================
# ุงูุฎุทูุฉ 2: ุงููุณุฎ ุงูุงุญุชูุงุทู
# =========================================
print_step "2. ุงูุฏูุชูุฑ ูุงุฒู: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ..."

BACKUP_FILE="bot_arabic_backup_$(date +%Y%m%d_%H%M%S).py"
cp bot_arabic.py "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    print_success "ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $BACKUP_FILE"
else
    print_error "ูุดู ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ"
    exit 1
fi

# =========================================
# ุงูุฎุทูุฉ 3: ุชุทุจูู ุงูุฅุตูุงุญุงุช
# =========================================
print_step "3. ูุฑูู ุงูุนูู: ุชุทุจูู ุงูุฅุตูุงุญุงุช..."

# ุชุดุบูู ูุธุงู ุงูุฅุตูุงุญ
if [ -f "comprehensive_fix.py" ]; then
    python3 comprehensive_fix.py bot_arabic.py
    if [ $? -eq 0 ]; then
        print_success "ุชู ุชุทุจูู ุงูุฅุตูุงุญุงุช ุงูุดุงููุฉ"
    else
        print_error "ูุดู ูู ุชุทุจูู ุงูุฅุตูุงุญุงุช"
        exit 1
    fi
else
    print_warning "ููู ุงูุฅุตูุงุญ ุบูุฑ ููุฌูุฏุ ุฌุงุฑู ุงูุฅุตูุงุญ ุงููุจุงุดุฑ..."
    
    # ุงูุฅุตูุงุญ ุงููุจุงุดุฑ ููุณุทุฑ 5495
    sed -i "5495s/\.format(notification\['id'\])//g" bot_arabic.py
    sed -i "5495s/{}/' ~ notification['id']|string ~ '/g" bot_arabic.py
    
    # ุงูุฅุตูุงุญ ุงููุจุงุดุฑ ููุณุทุฑ 5288
    sed -i "5288s/\.format(notification_count)//g" bot_arabic.py
    sed -i "5288s/{}/' ~ notification_count|string ~ '/g" bot_arabic.py
    
    print_success "ุชู ุงูุฅุตูุงุญ ุงููุจุงุดุฑ ููุณุทูุฑ ุงููููุฉ"
fi

# =========================================
# ุงูุฎุทูุฉ 4: ุงูุงุฎุชุจุงุฑ
# =========================================
print_step "4. ูุฑูู ุงูุฌูุฏุฉ: ุงูุงุฎุชุจุงุฑ ุงูุดุงูู..."

if [ -f "team_test_system.py" ]; then
    python3 team_test_system.py bot_arabic.py
    TEST_RESULT=$?
    
    if [ $TEST_RESULT -eq 0 ]; then
        print_success "ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช"
    else
        print_error "ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช"
        print_warning "ุฌุงุฑู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ..."
        cp "$BACKUP_FILE" bot_arabic.py
        exit 1
    fi
else
    print_warning "ููู ุงูุงุฎุชุจุงุฑ ุบูุฑ ููุฌูุฏุ ุฌุงุฑู ุงูุงุฎุชุจุงุฑ ุงูุฃุณุงุณู..."
    
    # ุงุฎุชุจุงุฑ ุจูุงุก ุงูุฌููุฉ ุงูุฃุณุงุณู
    python3 -m py_compile bot_arabic.py
    if [ $? -eq 0 ]; then
        print_success "ุจูุงุก ุงูุฌููุฉ ุตุญูุญ"
    else
        print_error "ุฎุทุฃ ูู ุจูุงุก ุงูุฌููุฉ"
        exit 1
    fi
fi

# =========================================
# ุงูุฎุทูุฉ 5: ุงูุชุญูู ุงูููุงุฆู
# =========================================
print_step "5. ุงููุฑูู ุจุฃูููู: ุงูุชุญูู ุงูููุงุฆู..."

echo "๐ ุงูุชุญูู ูู ุงููุดุงูู ุงููุนุฑููุฉ..."

# ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ .format() ูู templates
FORMAT_ERRORS=$(grep -n "{{.*\.format(.*).*}}" bot_arabic.py | wc -l)
if [ "$FORMAT_ERRORS" -eq 0 ]; then
    print_success "ูุง ุชูุฌุฏ .format() ูู templates"
else
    print_error "ูุง ูุฒุงู ููุงู $FORMAT_ERRORS ูุดููุฉ"
    exit 1
fi

# ุงูุชุญูู ูู ุงูุณุทูุฑ ุงููููุฉ
echo "๐ ูุญุต ุงูุณุทูุฑ ุงููููุฉ..."

CHECK_5495=$(sed -n '5495p' bot_arabic.py | grep -c "notification\['id'\]|string")
CHECK_5288=$(sed -n '5288p' bot_arabic.py | grep -c "notification_count|string")

if [ "$CHECK_5495" -eq 1 ]; then
    print_success "ุงูุณุทุฑ 5495 ุตุญูุญ"
else
    print_error "ูุดููุฉ ูู ุงูุณุทุฑ 5495"
fi

if [ "$CHECK_5288" -eq 1 ]; then
    print_success "ุงูุณุทุฑ 5288 ุตุญูุญ"
else
    print_error "ูุดููุฉ ูู ุงูุณุทุฑ 5288"
fi

# =========================================
# ุงูุฎุทูุฉ 6: ุงููุดุฑ
# =========================================
print_step "6. ุงููุดุฑ ุงูููุงุฆู..."

echo "========================================="
echo "๐ ุงููุธุงู ุฌุงูุฒ ููุชุดุบูู!"
echo "========================================="
echo "๐ ููุฎุต ุงูุนูููุฉ:"
echo "   - ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $BACKUP_FILE"
echo "   - ุงูููู ุงููุตูุญ: bot_arabic.py"
echo "   - ุงูุญุงูุฉ: ุฌุงูุฒ ููุชุดุบูู"
echo "========================================="
echo "๐ ุจุฏุก ุชุดุบูู ุงูุชุทุจูู..."
echo "========================================="

# ุจุฏุก ุชุดุบูู ุงูุชุทุจูู
exec python3 bot_arabic.py
